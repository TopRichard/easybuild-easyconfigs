easyblock = 'ConfigureMake'

name = 'Yambo'
version = '5.1.1'
local_yambo_libs_ver = '0.0.2'

homepage = 'http://www.yambo-code.org'

description = """Yambo is a FORTRAN/C code for Many-Body calculations in solid state and molecular physics.
 Yambo relies on the Kohn-Sham wavefunctions generated by two DFT public codes: abinit, and PWscf."""

toolchain = {'name': 'foss', 'version': '2021a'}


source_urls = ['https://github.com/yambo-code/yambo/archive/refs/tags/']
sources = [
    '%(version)s.tar.gz',  # Yambo
    {
        'source_urls': ['https://github.com/yambo-code/yambo-libraries/archive/'],
        'filename': '%s.tar.gz' % local_yambo_libs_ver,
        'extract_cmd': 'tar --strip-components=1 -xzf %s -C yambo-%(version)s/lib/yambo/',
    },
    {
        'source_urls': ['https://github.com/yambo-code/yambo/files/962173/'],
        'filename': 'iotk-y1.2.2.tar.gz',
        'extract_cmd': 'cp %s yambo-%(version)s/lib/archive/',
    },
]
checksums = [
    {'5.1.1.tar.gz': 'c85036ca60507e627c47b6c6aee8241830349e88110e1ce9132ef03ab2c4e9f6'},
    {'0.0.2.tar.gz': 'cac7e4bf93e16d3cdf640d034e15854455a08dad796aece3cad5c7c491a68a59'},
    {'iotk-y1.2.2.tar.gz': 'c0a4eb19f3e885d83d7afa52eb90658fba7cb1cb6e66049866a98dcc980de543'},
]

dependencies = [
    ('HDF5', '1.10.7'),
    ('netCDF', '4.8.0'),
    ('netCDF-Fortran', '4.5.3'),
    ('PETSc', '3.15.1'),
    ('SLEPc', '3.15.1'),
    ('libxc', '5.1.5'),
    ('FFTW', '3.3.9'),
]

configopts = '--enable-hdf5-par-io --enable-mpi --enable-open-mp  --enable-iotk '
configopts += '--enable-msgs-comps  '
configopts += '--with-blas-libs="-lflexiblas" '
configopts += '--with-lapack-libs="-lflexiblas" '
configopts += '--with-fft-path="$EBROOTFFTW" '
configopts += '--with-netcdf-path="$EBROOTNETCDF" '
configopts += '--with-netcdff-path="$EBROOTNETCDFMINFORTRAN" '
configopts += '--with-hdf5-path="$EBROOTHDF5" '
configopts += '--with-libxc-path="$EBROOTLIBXC" '
configopts += '--with-hdf5-path="$EBROOTHDF5" --with-petsc-path="$EBROOTPETSC" '
configopts += '--with-slepc-path="$EBROOTSLEPC" --with-libxc-path="$EBROOTLIBXC" '
configopts += '--enable-par-linalg --enable-slepc-linalg '
configopts += 'CPP="x86_64-pc-linux-gnu-gcc -E" '
configopts += 'CPPFLAGS="-P" '
parallel = 4
buildopts = 'all'

skipsteps = ['install']

postinstallcmds = [
    "cp -p %(builddir)s/%(namelower)s-%(version)s/lib/external/gfortran/mpifort/bin/* %(installdir)s/bin/",
]

sanity_check_paths = {
    'files': ['bin/' + x for x in ['a2y', 'p2y', 'yambo', 'yambo_ph', 'ypp', 'ypp_ph',
                                   'iotk', 'iotk.x']],
    'dirs': []
}

sanity_check_commands = ["yambo -h"]

moduleclass = 'phys'
